{
    "type": "object",
    "title": "GPIO Driver Configuration Type",
    "description": "Digital inputs and outputs configuration",
    "configFile": {
        "path": "/etc/wb-homa-gpio.conf",
        "service": "wb-homa-gpio"
    },
    "definitions": {
        "common_line_properties": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string",
                    "title": "MQTT id",
                    "minLength" : 1,
                    "propertyOrder": 1
                },
                // order 2: reserved for gpio or offset
                "direction": {
                    "type": "string",
                    "title": "Direction",
                    "enum": [
                        "input",
                        "output"
                    ],
                    "enum_titles" : ["Input", "Output"],
                    "default": "input",
                    "propertyOrder": 3
                },
                "inverted": {
                    "type": "boolean",
                    "title": "Invert polarity",
                    "default": false,
                    "_format": "checkbox",
                    "propertyOrder": 4
                },
                "type": {
                    "type": "string",
                    "title": "Pulse counter type (if any)",
                    "enum": [
                        "",
                        "watt_meter",
                        "water_meter"
                    ],
                    "default": "",
                    "propertyOrder": 5
                },
                // orders 6, 7: reserved for open_drain and open_source
                "edge": {
                    "type": "string",
                    "title": "Pulse counter interrupt edge",
                    "enum": [
                        "rising",
                        "falling",
                        "both"
                    ],
                    "default": "both",
                    "propertOrder": 8
                },
                "multiplier": {
                    "type": "number",
                    "title": "Number of pulses per unit (kWh or m^3)",
                    "propertyOrder": 9
                },
                "decimal_points_current" : {
                    "type" : "number",
                    "title" : "Number of decimal places in _current topic (pulse counters only)",
                    "default" : 2,
                    "min" : 0,
                    "propertyOrder": 10
                },
                "decimal_points_total" : {
                    "type" : "number",
                    "title" : "Number of decimal places in _total topic (pulse counters only)",
                    "default" : 2,
                    "min" : 0,
                    "propertyOrder": 11
                },
                "initial_state": {
                    "type": "boolean",
                    "title": "Initial state for output GPIO",
                    "default": false,
                    "_format": "checkbox",
                    "propertyOrder": 12
                }
            },
            "required": [
                "name"
            ]
        },
        "gpio_channel": {
            "type": "object",
            "title": "GPIO channel",
            "headerTemplate": "GPIO {{ |self.gpio|}} {{(|self.name|)}}",
            "allOf": [{ "$ref": "#/definitions/common_line_properties" }],

            "properties": {
                "gpio": {
                    "type": "integer",
                    "title": "GPIO number",
                    "propertyOrder": 2
                }
            },
            "required": [
                "gpio"
            ],
            "defaultProperties": [
                "name",
                "gpio",
                "direction"
            ]
        },
        "gpio_line": {
            "type": "object",
            "title": "GPIO line",
            "headerTemplate": "GPIO line {{ |self.offset|}} {{(|self.name|)}}",
            "allOf": [{ "$ref": "#/definitions/common_line_properties" }],

            "properties": {
                "offset": {
                    "type": "integer",
                    "title": "GPIO line offset",
                    "propertyOrder": 2
                },
                "open_drain": {
                    "type": "boolean",
                    "title": "Open drain",
                    "default": false,
                    "_format": "checkbox",
                    "propertyOrder": 6
                },
                "open_source": {
                    "type": "boolean",
                    "title": "Open source",
                    "default": false,
                    "_format": "checkbox",
                    "propertyOrder": 7
                }
            },
            "required": [
                "offset"
            ],
            "defaultProperties": [
                "name",
                "offset",
                "direction"
            ]
        },
        "chip_by_path": {
            "title": "By device path",
            "properties": {
                "path": {
                    "type": "string",
                    "title": "Path to GPIO chip",
                    "minLength": 1,
                    "propertyOrder": 1
                }
            },
            "required": [
                "path"
            ]
        },
        "chip_by_number": {
            "title": "By number",
            "properties": {
                "number": {
                    "type": "integer",
                    "title": "Number of GPIO chip",
                    "minimum": 0,
                    "propertyOrder": 1
                }
            },
            "required": [
                "number"
            ]
        },
        "gpio_chip": {
            "type": "object",
            "title": "GPIO chip",
            "headerTemplate": "GPIO chip {{at |self.path|}} {{number |self.number|}}",
            "allOf": [
                {
                    "type": "object",
                    "properties": {
                        "lines": {
                            "type": "array",
                            "title": "Lines of GPIO chip",
                            "items": {
                                "$ref": "#/definitions/gpio_line"
                            },
                            "minItems": 1,
                            "propertyOrder": 2
                        }
                    },
                    "required": [
                        "lines"
                    ]
                }
            ],
            "remove_empty_properties": true,
            "oneOf": [
                {   // path is specified; if path and number are specified: path will be used
                    "allOf": [
                        {
                            "$ref": "#/definitions/chip_by_path"
                        }
                    ]
                },
                {   // number is specified
                    "allOf": [
                        {
                            "$ref": "#/definitions/chip_by_number"
                        }
                    ],
                    "not": {
                        "required": [
                            "path"
                        ]
                    }
                }
            ]
        }
    },
    "oneOf": [
        {
            "title": "Sysfs (deprecated)",
            "properties": {
                "device_name": {
                    "type": "string",
                    "title": "MQTT device name",
                    "default": "GPIOs",
                    "propertyOrder": 1
                },
                "channels": {
                    "type": "array",
                    "title": "List of GPIO channels",
                    "items": {
                        "$ref": "#/definitions/gpio_channel"
                    },
                    "minItems": 1,
                    "_format": "",
                    "propertyOrder": 2
                }
            },
            "required": [
                "device_name",
                "channels"
            ]
        },
        {
            "title": "Charactrer Device",
            "properties": {
                "device_name": {
                    "type": "string",
                    "title": "MQTT device name",
                    "default": "GPIOs",
                    "propertyOrder": 1
                },
                "chips": {
                    "type": "array",
                    "title": "List of GPIO chips",
                    "items":{
                        "$ref": "#/definitions/gpio_chip"
                    },
                    "_format": "",
                    "propertyOrder": 2
                }
            },
            "required": [
                "device_name",
                "chips"
            ],
            "_format": "",
            "propertyOrder": 2
        }
    ]
}
